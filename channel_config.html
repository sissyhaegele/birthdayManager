<!-- channel_config.html - F√ºgen Sie dies in den Bereiche-Tab Ihrer HTML ein -->

<style>
.channel-config-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
}

.channel-config-content {
    background: white;
    width: 90%;
    max-width: 800px;
    margin: 50px auto;
    border-radius: 10px;
    padding: 30px;
    max-height: 80vh;
    overflow-y: auto;
}

.channel-section {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    background: #f8f9fa;
}

.channel-section.enabled {
    background: #e8f5e9;
    border-color: #4caf50;
}

.channel-header {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    cursor: pointer;
}

.channel-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    font-size: 20px;
    color: white;
}

.whatsapp-icon { background: #25D366; }
.email-icon { background: #EA4335; }
.telegram-icon { background: #0088cc; }
.webhook-icon { background: #ff9800; }

.channel-fields {
    display: none;
    margin-top: 15px;
}

.channel-fields.show {
    display: block;
}

.field-group {
    margin-bottom: 10px;
}

.field-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
}

.field-group input, .field-group select, .field-group textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
}
</style>

<div id="channelConfigModal" class="channel-config-modal">
    <div class="channel-config-content">
        <h2>‚öôÔ∏è Kommunikationskan√§le konfigurieren</h2>
        <h3 id="configGroupName" style="color: #667eea; margin-bottom: 20px;"></h3>
        
        <!-- WhatsApp -->
        <div class="channel-section" id="whatsappSection">
            <div class="channel-header" onclick="toggleChannel('whatsapp')">
                <div class="channel-icon whatsapp-icon">üì±</div>
                <div style="flex: 1;">
                    <h4>WhatsApp</h4>
                    <small>Nachrichten √ºber WhatsApp-Gruppen senden</small>
                </div>
                <input type="checkbox" id="whatsapp_enabled" onchange="updateChannelSection('whatsapp')" style="width: 24px; height: 24px;">
            </div>
            <div class="channel-fields" id="whatsappFields">
                <div class="field-group">
                    <label>Sende-Typ:</label>
                    <select id="whatsapp_type">
                        <option value="group">Gruppe</option>
                        <option value="broadcast">Broadcast-Liste</option>
                        <option value="individual">Einzelnachrichten</option>
                    </select>
                </div>
                <div class="field-group">
                    <label>Gruppen-ID/Name:</label>
                    <input type="text" id="whatsapp_group_id" placeholder="z.B. Familie_WhatsApp oder CDU_Gruppe">
                    <small style="color: #666;">Der Name der WhatsApp-Gruppe (wird in Zwischenablage kopiert)</small>
                </div>
            </div>
        </div>

        <!-- E-Mail -->
        <div class="channel-section" id="emailSection">
            <div class="channel-header" onclick="toggleChannel('email')">
                <div class="channel-icon email-icon">‚úâÔ∏è</div>
                <div style="flex: 1;">
                    <h4>E-Mail</h4>
                    <small>E-Mail-Benachrichtigungen versenden</small>
                </div>
                <input type="checkbox" id="email_enabled" onchange="updateChannelSection('email')" style="width: 24px; height: 24px;">
            </div>
            <div class="channel-fields" id="emailFields">
                <div class="field-group">
                    <label>E-Mail-Adressen (kommagetrennt):</label>
                    <textarea id="email_addresses" rows="3" placeholder="max@example.com, sissy@example.com"></textarea>
                </div>
                <div class="field-group">
                    <label>Absender-Adresse (optional):</label>
                    <input type="email" id="email_from" placeholder="birthday-manager@example.com">
                    <small style="color: #666;">Leer = Standard-Absender verwenden</small>
                </div>
            </div>
        </div>

        <!-- Telegram -->
        <div class="channel-section" id="telegramSection">
            <div class="channel-header" onclick="toggleChannel('telegram')">
                <div class="channel-icon telegram-icon">‚úàÔ∏è</div>
                <div style="flex: 1;">
                    <h4>Telegram</h4>
                    <small>Nachrichten √ºber Telegram Bot senden</small>
                </div>
                <input type="checkbox" id="telegram_enabled" onchange="updateChannelSection('telegram')" style="width: 24px; height: 24px;">
            </div>
            <div class="channel-fields" id="telegramFields">
                <div class="field-group">
                    <label>Chat-ID oder @username:</label>
                    <input type="text" id="telegram_chat_id" placeholder="-1001234567890 oder @gruppenname">
                </div>
                <div class="field-group">
                    <label>Bot Token (optional, falls nicht global):</label>
                    <input type="text" id="telegram_bot_token" placeholder="123456:ABC-DEF...">
                    <small style="color: #666;">Token vom @BotFather</small>
                </div>
            </div>
        </div>

        <!-- Webhook -->
        <div class="channel-section" id="webhookSection">
            <div class="channel-header" onclick="toggleChannel('webhook')">
                <div class="channel-icon webhook-icon">üîó</div>
                <div style="flex: 1;">
                    <h4>Webhook</h4>
                    <small>An externe Services senden (Slack, Discord, etc.)</small>
                </div>
                <input type="checkbox" id="webhook_enabled" onchange="updateChannelSection('webhook')" style="width: 24px; height: 24px;">
            </div>
            <div class="channel-fields" id="webhookFields">
                <div class="field-group">
                    <label>Webhook URL:</label>
                    <input type="url" id="webhook_url" placeholder="https://hooks.slack.com/services/...">
                    <small style="color: #666;">POST Request mit JSON wird gesendet</small>
                </div>
            </div>
        </div>

        <!-- Automatisierung -->
        <div style="margin-top: 30px; padding: 20px; background: #e3f2fd; border-radius: 8px;">
            <h4>ü§ñ Automatische Benachrichtigungen</h4>
            <div style="margin-top: 15px;">
                <label style="display: block; margin-bottom: 10px;">
                    <input type="checkbox" id="auto_send_morning" style="margin-right: 10px;">
                    T√§gliche Morgenerinnerung (8:00 Uhr) f√ºr Geburtstage
                </label>
                <label style="display: block;">
                    <input type="checkbox" id="auto_send_weekly" style="margin-right: 10px;">
                    W√∂chentliche √úbersicht (Montags) der kommenden Geburtstage
                </label>
            </div>
        </div>

        <!-- Buttons -->
        <div style="margin-top: 30px; display: flex; gap: 10px;">
            <button class="btn btn-primary" onclick="saveChannelConfig()">
                üíæ Konfiguration speichern
            </button>
            <button class="btn btn-success" onclick="testChannels()">
                üì§ Test-Nachricht senden
            </button>
            <button class="btn btn-secondary" onclick="closeChannelConfig()">
                Schlie√üen
            </button>
        </div>
    </div>
</div>

<script>
// Kommunikations-Port
const COMM_PORT = 3002;
let currentConfigGroup = null;

// √ñffne Kanal-Konfiguration
async function configureChannels(groupName) {
    currentConfigGroup = groupName;
    document.getElementById('configGroupName').textContent = `Bereich: ${groupName}`;
    
    // Lade bestehende Konfiguration
    try {
        const response = await fetch(`http://localhost:${COMM_PORT}/api/communication/group/${groupName}`);
        if (response.ok) {
            const config = await response.json();
            
            // WhatsApp
            document.getElementById('whatsapp_enabled').checked = config.whatsapp_enabled;
            document.getElementById('whatsapp_type').value = config.whatsapp_type || 'group';
            document.getElementById('whatsapp_group_id').value = config.whatsapp_group_id || '';
            
            // E-Mail
            document.getElementById('email_enabled').checked = config.email_enabled;
            document.getElementById('email_addresses').value = config.email_addresses || '';
            document.getElementById('email_from').value = config.email_from || '';
            
            // Telegram
            document.getElementById('telegram_enabled').checked = config.telegram_enabled;
            document.getElementById('telegram_chat_id').value = config.telegram_chat_id || '';
            document.getElementById('telegram_bot_token').value = config.telegram_bot_token || '';
            
            // Webhook
            document.getElementById('webhook_enabled').checked = config.webhook_enabled;
            document.getElementById('webhook_url').value = config.webhook_url || '';
            
            // Automatisierung
            document.getElementById('auto_send_morning').checked = config.auto_send_morning;
            document.getElementById('auto_send_weekly').checked = config.auto_send_weekly;
            
            // Update UI
            ['whatsapp', 'email', 'telegram', 'webhook'].forEach(channel => {
                updateChannelSection(channel);
            });
        }
    } catch (error) {
        console.error('Fehler beim Laden der Konfiguration:', error);
    }
    
    document.getElementById('channelConfigModal').style.display = 'block';
}

// Toggle Kanal-Felder
function toggleChannel(channel) {
    const checkbox = document.getElementById(`${channel}_enabled`);
    checkbox.checked = !checkbox.checked;
    updateChannelSection(channel);
}

// Update Kanal-Section
function updateChannelSection(channel) {
    const enabled = document.getElementById(`${channel}_enabled`).checked;
    const section = document.getElementById(`${channel}Section`);
    const fields = document.getElementById(`${channel}Fields`);
    
    if (enabled) {
        section.classList.add('enabled');
        fields.classList.add('show');
    } else {
        section.classList.remove('enabled');
        fields.classList.remove('show');
    }
}

// Speichere Konfiguration
async function saveChannelConfig() {
    if (!currentConfigGroup) return;
    
    const config = {
        whatsapp_enabled: document.getElementById('whatsapp_enabled').checked,
        whatsapp_type: document.getElementById('whatsapp_type').value,
        whatsapp_group_id: document.getElementById('whatsapp_group_id').value,
        
        email_enabled: document.getElementById('email_enabled').checked,
        email_addresses: document.getElementById('email_addresses').value,
        email_from: document.getElementById('email_from').value,
        
        telegram_enabled: document.getElementById('telegram_enabled').checked,
        telegram_chat_id: document.getElementById('telegram_chat_id').value,
        telegram_bot_token: document.getElementById('telegram_bot_token').value,
        
        webhook_enabled: document.getElementById('webhook_enabled').checked,
        webhook_url: document.getElementById('webhook_url').value,
        
        auto_send_morning: document.getElementById('auto_send_morning').checked,
        auto_send_weekly: document.getElementById('auto_send_weekly').checked
    };
    
    try {
        const response = await fetch(`http://localhost:${COMM_PORT}/api/communication/group/${currentConfigGroup}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
        });
        
        if (response.ok) {
            alert(`‚úÖ Konfiguration f√ºr "${currentConfigGroup}" gespeichert!`);
            updateGroupsList(); // Refresh Liste
        } else {
            alert('Fehler beim Speichern!');
        }
    } catch (error) {
        alert('Server nicht erreichbar! Starte communication_server.js auf Port 3002');
    }
}

// Test-Nachricht senden
async function testChannels() {
    if (!currentConfigGroup) return;
    
    if (!confirm(`Test-Nachricht an alle konfigurierten Kan√§le f√ºr "${currentConfigGroup}" senden?`)) {
        return;
    }
    
    try {
        const response = await fetch(`http://localhost:${COMM_PORT}/api/communication/test/${currentConfigGroup}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            const result = await response.json();
            
            let message = 'Test-Ergebnisse:\n\n';
            result.results.forEach(r => {
                const status = r.status === 'sent' ? '‚úÖ' : '‚ùå';
                message += `${status} ${r.channel}: ${r.status}`;
                if (r.error) message += ` (${r.error})`;
                message += '\n';
            });
            
            alert(message);
        }
    } catch (error) {
        alert('Fehler beim Senden der Test-Nachricht!');
    }
}

// Schlie√üe Konfiguration
function closeChannelConfig() {
    document.getElementById('channelConfigModal').style.display = 'none';
    currentConfigGroup = null;
}

// Erweitere die Gruppenliste mit Channel-Icons
async function updateGroupsListWithChannels() {
    try {
        const response = await fetch(`http://localhost:${COMM_PORT}/api/communication/groups`);
        if (!response.ok) return;
        
        const groups = await response.json();
        const list = document.getElementById('groupsList');
        if (!list) return;
        
        let html = '<h3>Bereiche mit Kommunikationskan√§len:</h3>';
        
        groups.forEach(group => {
            const channels = [];
            if (group.whatsapp_enabled) channels.push('üì±');
            if (group.email_enabled) channels.push('‚úâÔ∏è');
            if (group.telegram_enabled) channels.push('‚úàÔ∏è');
            if (group.webhook_enabled) channels.push('üîó');
            
            const autoFlags = [];
            if (group.auto_send_morning) autoFlags.push('üåÖ');
            if (group.auto_send_weekly) autoFlags.push('üìÖ');
            
            html += `
                <div style="padding: 15px; background: #f8f9fa; margin-bottom: 10px; border-radius: 5px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${group.name}</strong> (${group.person_count || 0} Personen)
                            <div style="margin-top: 5px;">
                                ${channels.length > 0 ? 
                                    `<span style="font-size: 20px;">${channels.join(' ')}</span>` : 
                                    '<span style="color: #999;">Keine Kan√§le konfiguriert</span>'}
                                ${autoFlags.length > 0 ? 
                                    `<span style="margin-left: 10px; font-size: 16px;">${autoFlags.join(' ')}</span>` : ''}
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="configureChannels('${group.name}')">
                            ‚öôÔ∏è Konfigurieren
                        </button>
                    </div>
                </div>
            `;
        });
        
        list.innerHTML = html;
        
    } catch (error) {
        console.log('Kommunikations-Server l√§uft nicht auf Port', COMM_PORT);
    }
}

// Ersetze originale updateGroupsList
const originalUpdateGroupsList = window.updateGroupsList;
window.updateGroupsList = function() {
    if (originalUpdateGroupsList) originalUpdateGroupsList();
    updateGroupsListWithChannels();
};

// Initial load
setTimeout(updateGroupsListWithChannels, 1000);
</script>
